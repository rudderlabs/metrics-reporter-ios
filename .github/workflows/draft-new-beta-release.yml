name: Draft new Beta release

on:
  workflow_dispatch:
    inputs:
      beta_version:
        description: "Beta version(Only single digit, example: 1)"
        required: true

permissions:
  contents: read

jobs:
  draft-new-beta-release:
    name: Draft a new Beta release
    runs-on: ubuntu-latest
    permissions:
      contents: read # GITHUB_TOKEN only needs read access
    if: startsWith(github.ref, 'refs/heads/fix/') || startsWith(github.ref, 'refs/heads/feat/')
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        with:
          app-id: ${{ vars.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_PRIVATE_KEY }}
          permission-contents: write # to create commits, tags, and push to private spec repo
          permission-pull-requests: write # to interact with GitHub API

      - name: Checkout source branch
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          fetch-depth: 0

      - name: Set Node 16
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 16

      # Calculate the next release version based on conventional semantic release
      - name: Create release branch
        id: create-release
        env:
          HUSKY: 0
          BETA_VERSION: ${{ github.event.inputs.beta_version }}
        run: |
          source_branch_name=${GITHUB_REF##*/}
          release_type=beta-release
          git fetch origin master
          git fetch --tags origin
          git merge origin/master
          current_version=$(jq -r .version package.json)

          npx standard-version --skip.commit --skip.tag --skip.changelog
          new_version="$(jq -r .version package.json).beta.$BETA_VERSION"
          git reset --hard

          branch_name="${release_type}/${new_version}"

          echo "Source branch for new release is $source_branch_name"
          echo "Current version is $current_version"
          echo "Release type is $release_type"
          echo "New version is $new_version"
          echo "New release branch name is $branch_name"

          echo "source_branch_name=$source_branch_name" >> $GITHUB_OUTPUT
          echo "branch_name=$branch_name" >> $GITHUB_OUTPUT
          echo "new_version=$new_version" >> $GITHUB_OUTPUT
          echo "CURRENT_VERSION_VALUE=$current_version" >> $GITHUB_ENV
          echo "NEW_VERSION_VALUE=$new_version" >> $GITHUB_ENV

      - name: Create release branch via GitHub API
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          BASE_SHA=$(git rev-parse origin/master)
          gh api repos/${{ github.repository }}/git/refs \
            --method POST \
            -f ref="refs/heads/${{ steps.create-release.outputs.branch_name }}" \
            -f sha="$BASE_SHA"

      - name: Bump version
        id: finish-release
        env:
          HUSKY: 0
        run: |
          echo "Current version: $CURRENT_VERSION_VALUE"
          echo "New version: $NEW_VERSION_VALUE"
          npx replace $CURRENT_VERSION_VALUE $NEW_VERSION_VALUE package.json
          echo ${{ steps.create-release.outputs.new_version }}
          echo "commit_summary=$SUMMARY" >> $GITHUB_OUTPUT

      - name: Create verified commit and tag via API
        uses: ryancyq/github-signed-commit@e9f3b28c80da7be66d24b8f501a5abe82a6b855f # v1.2.0
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        with:
          branch-name: ${{ steps.create-release.outputs.branch_name }}
          commit-message: 'chore(beta-release): v${{ steps.create-release.outputs.new_version }}'
          files: |
            package.json
          tag: 'v${{ steps.create-release.outputs.new_version }}'

      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          ref: '${{ steps.create-release.outputs.branch_name }}'

      - name: Install Cocoapods
        run: gem install cocoapods

      - name: Add Private Spec Repo to CocoaPods installation
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          pod repo add MetricsReporter https://x-access-token:$GH_TOKEN@github.com/rudderlabs/Specs.git

      - name: Add Podspec to repo
        run: |
          pod repo push MetricsReporter MetricsReporter.podspec
